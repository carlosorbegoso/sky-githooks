#!/bin/bash
# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# protected branches
PROTECTED_BRANCHES=("main" "master" "develop" "release")
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# check for unresolved merge conflicts in committed files about to be pushed
CONFLICT_FILES=$(git grep -lE '^(<<<<<<<|=======|>>>>>>>)' HEAD 2>/dev/null)
if [ -n "$CONFLICT_FILES" ]; then
    echo -e "${RED}ðŸ˜¢ ERROR:${NC} Unresolved merge conflicts found in:"
    echo "$CONFLICT_FILES" | while IFS= read -r f; do
        echo -e "  ${CYAN}$f${NC}"
    done
    exit 1
fi

# block direct push to protected branches
if [[ " ${PROTECTED_BRANCHES[@]} " =~ " ${CURRENT_BRANCH} " ]]; then
    echo -e "${RED}ðŸ˜¢ ERROR: Direct pushes to the ${CURRENT_BRANCH} branch are not allowed. Please create a pull request instead.${NC}"
    exit 1
fi
# only apply squash check on feature/* branches
if [[ "$CURRENT_BRANCH" == feature/* ]]; then
    echo -e "${YELLOW}INFO:${NC} Squash commits on feature branches is recommended."

    # if no upstream yet (first push), skip squash check
    if ! git rev-parse --abbrev-ref @{u} > /dev/null 2>&1; then
        echo -e "${YELLOW}INFO:${NC} No upstream branch set yet for ${CURRENT_BRANCH}. Skipping squash check."
    else
        UPSTREAM=$(git rev-parse --abbrev-ref @{u})
        BASE=$(git merge-base HEAD "$UPSTREAM")

        if [ -z "$BASE" ]; then
            echo -e "${YELLOW}WARNING:${NC} Could not determine merge base for ${CURRENT_BRANCH}. Skipping squash check."
        else
            COMMITS=$(git rev-list --count "$BASE"..HEAD)

            if [ "$COMMITS" -gt 1 ]; then
                echo -e "${YELLOW}WARNING:${NC} You have $COMMITS commits on ${CURRENT_BRANCH}."
                echo -e "${YELLOW}HINT:${NC} Consider squashing before pushing with: ${CYAN}git rebase -i ${UPSTREAM}${NC}"
                git log "$BASE"..HEAD --oneline | while IFS= read -r line; do
                    echo -e "  ${CYAN}Â·${NC} $line"
                done
            fi
        fi
    fi
fi

# show summary of commits about to be pushed
if git rev-parse --abbrev-ref @{u} > /dev/null 2>&1; then
    PUSH_BASE=$(git rev-parse @{u})
    PUSH_COMMITS=$(git rev-list --count "$PUSH_BASE"..HEAD)
    if [ "$PUSH_COMMITS" -gt 0 ]; then
        echo -e "${CYAN}Summary:${NC} $PUSH_COMMITS commit(s) will be pushed to ${CYAN}$(git rev-parse --abbrev-ref @{u})${NC}:"
        git log "$PUSH_BASE"..HEAD --oneline | while IFS= read -r line; do
            echo -e "  ${GREEN}â†’${NC} $line"
        done
    fi
fi

exit 0